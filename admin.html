<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Certificate Tracker</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #fff;
            padding: 20px;
            color: #13343b;
            margin: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #21808d;
            margin-bottom: 10px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .back-btn {
            padding: 10px 20px;
            background: #21808d;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .back-btn:hover {
            background: #1d7480;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #dedede;
        }
        .stat-number {
            font-size: 2.5rem;
            font-weight: 600;
            color: #21808d;
        }
        .stat-label {
            color: #626c71;
            font-size: 14px;
            margin-top: 5px;
        }
        .table-container {
            background: white;
            border: 1px solid #dedede;
            border-radius: 8px;
            overflow: auto;
            max-height: 600px;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            border-bottom: 2px solid #dedede;
        }
        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        tr:hover {
            background: #f8f9fa;
        }
        .export-btn {
            padding: 10px 20px;
            background: #21808d;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 10px;
        }
        .export-btn:hover {
            background: #1d7480;
        }
        .loading {
            text-align: center;
            padding: 40px;
        }
        .spinner {
            border: 3px solid rgba(33, 128, 141, 0.2);
            border-top: 3px solid #21808d;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            .stat-number {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>üîê Admin Dashboard</h1>
                <p style="color: #626c71;">Anti-Drug Awareness Marathon - Certificate Tracker</p>
            </div>
            <div>
                <button class="export-btn" onclick="exportToCSV()">üì• Export CSV</button>
                <a href="index.html" class="back-btn">‚Üê Back to Portal</a>
            </div>
        </div>
        
        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-number" id="downloadedCount">-</div>
                <div class="stat-label">Total Downloads</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="uniqueCount">-</div>
                <div class="stat-label">Unique Users</div>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Loading download data...</p>
        </div>

        <div class="table-container" id="tableContainer" style="display:none;">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Roll Number</th>
                        <th>Downloaded At</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCZZdmmCCZtq0YkMJ2rihL0l-jd6ulWvyc",
            authDomain: "certificates-nss-67fa9.firebaseapp.com",
            projectId: "certificates-nss-67fa9",
            storageBucket: "certificates-nss-67fa9.firebasestorage.app",
            messagingSenderId: "757768571172",
            appId: "1:757768571172:web:462a42300da205e3810bb1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let downloads = [];

        async function loadDownloads() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('tableContainer').style.display = 'none';

            try {
                const q = query(collection(db, "downloads"), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                
                downloads = [];
                querySnapshot.forEach((doc) => {
                    downloads.push(doc.data());
                });

                updateStats();
                renderTable();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('tableContainer').style.display = 'block';
            } catch (error) {
                console.error('Error loading downloads:', error);
                document.getElementById('loading').innerHTML = `
                    <p style="color: #c0152f;">Error loading data: ${error.message}</p>
                    <button onclick="location.reload()" style="margin-top: 10px; padding: 8px 16px; background: #21808d; color: white; border: none; border-radius: 6px; cursor: pointer;">Retry</button>
                `;
            }
        }

        function updateStats() {
            const uniqueRollNos = new Set(downloads.map(d => d.roll_no));
            document.getElementById('downloadedCount').textContent = downloads.length;
            document.getElementById('uniqueCount').textContent = uniqueRollNos.size;
        }

        function renderTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            downloads.forEach((download, index) => {
                const row = document.createElement('tr');
                const timestamp = download.timestamp;
                const dateStr = timestamp ? new Date(timestamp.seconds * 1000).toLocaleString('en-IN') : 'Unknown';
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><strong>${download.roll_no}</strong></td>
                    <td>${dateStr}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        window.exportToCSV = function() {
            let csvContent = "Roll Number,Downloaded At\n";
            
            downloads.forEach(d => {
                const timestamp = d.timestamp;
                const dateStr = timestamp ? new Date(timestamp.seconds * 1000).toLocaleString('en-IN') : 'Unknown';
                csvContent += `${d.roll_no},${dateStr}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `certificate_downloads_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        };

        loadDownloads();
    </script>
</body>
</html>
